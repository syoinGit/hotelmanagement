<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portfolio.hotel.management.repository.HotelRepository">

  <select id="findAllGuest" resultType="com.portfolio.hotel.management.data.guest.Guest">
    SELECT * FROM guest
  </select>

  <select id="findAllBooking" resultType="com.portfolio.hotel.management.data.booking.Booking">
    SELECT * FROM booking
  </select>

  <select id="findAllReservation"
    resultType="com.portfolio.hotel.management.data.reservation.Reservation">
    SELECT * FROM reservation
  </select>

  <select id="findGuestsTodayCheckIn" resultType="com.portfolio.hotel.management.data.guest.Guest">
    SELECT
    guest.id, guest.name, guest.kana_name, guest.gender, guest.age,
    guest.region, guest.email, guest.phone, guest.deleted
    FROM guest
    INNER JOIN reservation ON guest.id = reservation.guest_id
    WHERE reservation.check_in_date = #{today}
    AND reservation.status = 'NOT_CHECKED_IN'
  </select>

  <select id="findReservationTodayCheckIn"
    resultType="com.portfolio.hotel.management.data.reservation.Reservation">
    SELECT * FROM reservation
    WHERE check_in_date = #{today}
    AND status = 'NOT_CHECKED_IN'
  </select>

  <select id="findGuestsTodayCheckOut" resultType="com.portfolio.hotel.management.data.guest.Guest">
    SELECT
    guest.id, guest.name, guest.kana_name, guest.gender, guest.age,
    guest.region, guest.email, guest.phone, guest.deleted
    FROM guest
    INNER JOIN reservation ON guest.id = reservation.guest_id
    WHERE reservation.check_out_date = #{today}
    AND reservation.status = 'CHECKED_IN'
  </select>

  <select id="findReservationTodayCheckOut"
    resultType="com.portfolio.hotel.management.data.reservation.Reservation">
    SELECT * FROM reservation
    WHERE check_out_date = #{today}
    AND status = 'CHECKED_IN'
  </select>

  <select id="searchGuest" resultType="com.portfolio.hotel.management.data.guest.Guest">
    SELECT * FROM guest
    <where>
      <if test="guest.id != null and guest.id != ''">AND id = #{guest.id}</if>
      <if test="guest.phone != null and guest.phone != ''">AND phone LIKE CONCAT('%',
        #{guest.phone}, '%')
      </if>
      <if test="guest.name != null and guest.name != ''">AND name LIKE CONCAT('%', #{guest.name},
        '%')
      </if>
      <if test="guest.kanaName != null and guest.kanaName != ''">AND kana_name LIKE CONCAT('%',
        #{guest.kanaName}, '%')
      </if>
    </where>
  </select>

  <select id="searchReservation"
    resultType="com.portfolio.hotel.management.data.reservation.Reservation" parameterType="string">
    SELECT * FROM reservation WHERE id = #{id}
  </select>

  <select id="matchGuest" parameterType="com.portfolio.hotel.management.data.guest.GuestSearch"
    resultType="com.portfolio.hotel.management.data.guest.Guest">
    SELECT * FROM guest
    WHERE name = #{name}
    AND kana_name = #{kanaName}
    AND phone = #{phone}
  </select>

  <select id="findTotalPriceById" resultType="java.math.BigDecimal">
    SELECT price FROM booking WHERE id = #{id}
  </select>

  <select id="findStatusById"
    resultType="com.portfolio.hotel.management.data.reservation.ReservationStatus">
    SELECT status FROM reservation WHERE id = #{id}
  </select>

  <insert id="insertGuest" parameterType="com.portfolio.hotel.management.data.guest.Guest">
    INSERT INTO guest (
    id, name, kana_name, gender, age, region, email, phone, deleted
    ) VALUES (
    #{id}, #{name}, #{kanaName}, #{gender}, #{age},
    #{region}, #{email}, #{phone}, 0
    )
  </insert>

  <insert id="insertBooking" parameterType="com.portfolio.hotel.management.data.booking.Booking">
    INSERT INTO booking (
    id, name, description, price, is_available
    ) VALUES (
    #{id}, #{name}, #{description}, #{price}, #{isAvailable}
    )
  </insert>

  <insert id="insertReservation"
    parameterType="com.portfolio.hotel.management.data.reservation.Reservation">
    INSERT INTO reservation (
    id, guest_id, booking_id, check_in_date, check_out_date,
    stay_days, total_price, status, memo, created_at
    ) VALUES (
    #{id}, #{guestId}, #{bookingId}, #{checkInDate}, #{checkOutDate},
    #{stayDays}, #{totalPrice}, #{status}, #{memo}, #{createdAt}
    )
  </insert>

  <update id="updateGuest" parameterType="com.portfolio.hotel.management.data.guest.Guest">
    UPDATE guest
    SET name = #{name},
    kana_name = #{kanaName},
    gender = #{gender},
    age = #{age},
    region = #{region},
    email = #{email},
    phone = #{phone},
    deleted = #{deleted}
    WHERE id = #{id}
  </update>

  <update id="updateReservation"
    parameterType="com.portfolio.hotel.management.data.reservation.Reservation">
    UPDATE reservation
    SET check_in_date = #{checkInDate},
    check_out_date = #{checkOutDate},
    stay_days = #{stayDays},
    total_price = #{totalPrice},
    status = #{status},
    memo = #{memo}
    WHERE id = #{id}
  </update>

  <update id="checkIn">
    UPDATE reservation
    SET status = 'CHECKED_IN'
    WHERE id = #{id}
  </update>

  <update id="checkOut">
    UPDATE reservation
    SET status = 'CHECKED_OUT'
    WHERE id = #{id}
  </update>

</mapper>